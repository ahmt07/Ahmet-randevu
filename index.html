<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ahmet Tekeli Erkek Kuaförü — Randevu Sistemi (Müşteri + Admin)</title>
<style>
:root{
  --ink:#0f172a;--muted:#475569;--bg:#f8fafc;--card:#ffffff;--line:#e5e7eb;
  --brand:#111827;--accent:#d4af37;--good:#16a34a;--bad:#dc2626;--warn:#f59e0b
}
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
header{background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}
.wrap{max-width:1100px;margin:0 auto;padding:10px 16px}
h1{font-size:20px;margin:.2rem 0;color:var(--brand)} .muted{color:var(--muted)}
nav.tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
nav.tabs button{border:1px solid var(--line);padding:8px 12px;border-radius:999px;background:#fff;cursor:pointer}
nav.tabs button.active{background:#111827;color:#fff}
section{display:none;padding:16px 0} section.active{display:block}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;margin:10px 0}
.grid{display:grid;gap:12px} .cols-2{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
label{display:block;font-weight:600;margin:.3rem 0 .1rem} input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
button.primary{background:#111827;color:#fff;border:1px solid #111827;padding:10px 14px;border-radius:10px;cursor:pointer}
button.ghost{border:1px solid var(--line);padding:8px 12px;border-radius:10px;background:#fff;cursor:pointer}
table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid #eef2f7;padding:8px;text-align:left} thead th{background:#111827;color:#fff;position:sticky;top:0}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px;background:#fff}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.slot{display:inline-block;margin:4px 6px;padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer}
.slot.disabled{opacity:.4;pointer-events:none;text-decoration:line-through}
.slot.selected{outline:2px solid var(--accent)}
.small{font-size:12px;color:var(--muted)}
.ok{color:var(--good)} .err{color:var(--bad)} .warn{color:var(--warn)}
footer{padding:30px 0;text-align:center;color:var(--muted)}
pre{white-space:pre-wrap;background:#f1f5f9;border:1px dashed #e2e8f0;padding:10px;border-radius:10px}
hr{border:none;border-top:1px solid var(--line);margin:14px 0}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <h1>Ahmet Tekeli Erkek Kuaförü — <span class="muted">Randevu Sistemi</span></h1>
      <span class="badge">Demo • Tek Dosya</span>
    </div>
    <nav class="tabs">
      <button class="tab-btn active" data-target="#musteri">Müşteri Portalı</button>
      <button class="tab-btn" data-target="#randevularim">Randevularım</button>
      <button class="tab-btn" data-target="#admin">Admin Paneli</button>
      <button class="tab-btn" data-target="#ayarlar">Ayarlar / Katalog</button>
      <button class="tab-btn" data-target="#dokuman">Nasıl Çalışır?</button>
    </nav>
  </div>
</header>

<main class="wrap">
  <section id="musteri" class="active">
    <div class="card">
      <h3>Müşteri Girişi / Kayıt</h3>
      <div class="grid cols-2">
        <div>
          <label>Ad Soyad</label><input id="c_name" placeholder="Adınız">
          <label>Telefon (WhatsApp)</label><input id="c_phone" placeholder="+90 5xx xxx xx xx">
          <button class="primary" id="loginBtn">Giriş / Kayıt</button>
          <div id="loginStatus" class="small"></div>
        </div>
        <div>
          <p class="small">Not: Demo ortamında SMS/OTP yoktur. Telefon numarası sizin kimliğiniz sayılır. Aynı telefonla tekrar girerseniz hesabınıza bağlanır.</p>
          <div id="whoami" class="small"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Randevu Oluştur</h3>
      <div class="grid cols-2">
        <div>
          <label>Hizmet</label>
          <select id="svc"></select>
          <label>Berber</label>
          <select id="staff"></select>
          <label>Tarih</label>
          <input type="date" id="date">
        </div>
        <div>
          <label>Uygun Saatler</label>
          <div id="slots" class="row"></div>
          <div class="small">Çalışma saatleri <span id="hoursLabel"></span>, slot aralığı <span id="slotSizeLabel"></span> dk.</div>
          <div class="row">
            <button class="primary" id="makeAppt">Randevu Oluştur</button>
            <button class="ghost" id="waPreview">WhatsApp Mesajı</button>
          </div>
          <div id="makeStatus" class="small"></div>
        </div>
      </div>
    </div>
  </section>

  <section id="randevularim">
    <div class="card">
      <h3>Randevularım</h3>
      <table id="myApptTbl">
        <thead><tr><th>Tarih</th><th>Saat</th><th>Hizmet</th><th>Berber</th><th>Durum</th><th>İşlem</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="small">Onay bekleyen randevular admin tarafından onaylandığında durum otomatik güncellenir.</div>
    </div>
  </section>

  <section id="admin">
    <div class="card">
      <h3>Admin Girişi</h3>
      <div class="row">
        <input id="adminPass" placeholder="Admin şifresi">
        <button class="primary" id="adminLogin">Giriş</button>
        <div id="adminStatus" class="small"></div>
      </div>
      <div class="small">Varsayılan şifre: <b id="defaultPwd"></b> (Ayarlar sekmesinden değiştirin.)</div>
    </div>

    <div id="adminArea" style="display:none">
      <div class="card">
        <div class="row">
          <h3>Onay Kuyruğu</h3>
          <button class="ghost" id="refreshAdmin">Yenile</button>
        </div>
        <table id="queueTbl">
          <thead><tr><th>Müşteri</th><th>Tel</th><th>Tarih</th><th>Saat</th><th>Hizmet</th><th>Berber</th><th>Süre</th><th>İşlem</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h3>Günlük Takvim</h3>
        <div class="row">
          <input type="date" id="calDate">
          <select id="calStaff"></select>
          <button class="ghost" id="viewCal">Görüntüle</button>
        </div>
        <table id="calTbl">
          <thead><tr><th>Saat</th><th>Müşteri</th><th>Hizmet</th><th>Durum</th><th>İşlem</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h3>Slot Blokla (Öğle arası, bakım vb.)</h3>
        <div class="grid cols-2">
          <div>
            <label>Berber</label><select id="blkStaff"></select>
            <label>Tarih</label><input type="date" id="blkDate">
          </div>
          <div>
            <label>Başlangıç</label><input type="time" id="blkStart" value="13:00">
            <label>Bitiş</label><input type="time" id="blkEnd" value="13:30">
            <button class="ghost" id="addBlock">Blok Ekle</button>
            <div id="blkStatus" class="small"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Dışa Aktar</h3>
        <div class="row">
          <button class="ghost" id="exportCSV">Randevular (CSV)</button>
          <button class="ghost" id="exportJSON">Tüm Veri (JSON)</button>
        </div>
      </div>
    </div>
  </section>

  <section id="ayarlar">
    <div class="card">
      <h3>Çalışma Ayarları</h3>
      <div class="grid cols-2">
        <div>
          <label>Açılış</label><input id="openTime" value="09:00" type="time">
          <label>Kapanış</label><input id="closeTime" value="21:00" type="time">
          <label>Slot (dk)</label><input id="slotSize" value="15" type="number" min="5" step="5">
          <label>Admin Şifresi</label><input id="adminPwdInput" placeholder="Yeni şifre gir">
          <button class="primary" id="saveSettings">Kaydet</button>
          <div id="settingsStatus" class="small"></div>
        </div>
        <div>
          <label>Berberler</label>
          <div id="staffList"></div>
          <div class="row">
            <input id="newStaffName" placeholder="Berber adı">
            <button class="ghost" id="addStaff">Ekle</button>
          </div>
          <hr>
          <label>Hizmetler</label>
          <div id="svcList"></div>
          <div class="row">
            <input id="newSvcName" placeholder="Hizmet adı">
            <input id="newSvcDur" type="number" placeholder="Süre (dk)" style="max-width:140px">
            <input id="newSvcPrice" type="number" placeholder="Fiyat (TL)" style="max-width:140px">
            <button class="ghost" id="addSvc">Ekle</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="dokuman">
    <div class="card">
      <h3>Nasıl Çalışır? (Özet)</h3>
      <ol>
        <li><b>Müşteri</b> ad-soyad ve telefon ile giriş yapar. Hizmet/berber/tarih-seçip uygun saatlerden birini tıklar ve randevu oluşturur. Randevu <b>“Onay Bekliyor”</b> durumunda kaydedilir.</li>
        <li><b>Admin</b> panele girip onay kuyruğundan randevuyu <b>Onaylar / Reddeder</b>. Onaylı randevular takvimi kilitler ve diğer müşterilere aynı saat/berber için kapatılır.</li>
        <li>Müşteri kendi panelinde randevusunu <b>iptal</b> edebilir veya <b>saat değiştirebilir</b>. Saat değiştirince yeniden onay kuyruğuna düşer.</li>
        <li><b>Blok</b> özelliğiyle öğle arası vb. zamanlar kapatılır. CSV/JSON ile dışa aktarım yapılabilir. “Takvime ekle (.ics)” linki mevcuttur.</li>
      </ol>
      <p class="small">Bu prototip <b>tek dosya</b> ve <b>localStorage</b> ile çalışır. Canlıya alırken bir veritabanı ve WhatsApp/SMS API bağlanması önerilir.</p>
      <pre>// WhatsApp hızlı mesajı örneği:
// https://wa.me/905xxxxxxxxx?text=Ahmet%20Tekeli%20Erkek%20Kuaf%C3%B6r%C3%BC%20randevu%20talebi:%2012%20Ekim%2018:30%20-%20Sa%C3%A7%20+%20Sakal</pre>
    </div>
  </section>
</main>

<footer>
  <div class="wrap">© Ahmet Tekeli Erkek Kuaförü — Randevu Sistemi (Demo) • Tek dosya HTML</div>
</footer>

<script>
// --- Utilities ---
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const fmtTime = t => t.padStart(5,'0');
const todayISO = () => new Date().toISOString().slice(0,10);
const toMinutes = hhmm => { const [h,m]=hhmm.split(':').map(Number); return h*60+m; }
const toHHMM = m => `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
const uuid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);
const storage = {
  get(k,def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def } },
  set(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
};

// --- Seed Data ---
const seed = () => {
  if (!storage.get('settings')) {
    storage.set('settings', {open:"09:00", close:"21:00", slot:15, adminPwd:"ahmet-admin-2025"});
  }
  if (!storage.get('staff')) {
    storage.set('staff', [
      {id:uuid(), name:"Ahmet Usta"},
      {id:uuid(), name:"Kadir Usta"},
      {id:uuid(), name:"Emre Usta"}
    ]);
  }
  if (!storage.get('services')) {
    storage.set('services', [
      {id:uuid(), name:"Saç Kesim", dur:30, price:400},
      {id:uuid(), name:"Saç + Sakal", dur:45, price:600},
      {id:uuid(), name:"Sakal", dur:20, price:300},
      {id:uuid(), name:"Çocuk Kesim", dur:30, price:350},
      {id:uuid(), name:"Fön / Yıkama", dur:15, price:150}
    ]);
  }
  if (!storage.get('users')) storage.set('users', []);
  if (!storage.get('appts')) storage.set('appts', []);
  if (!storage.get('blocks')) storage.set('blocks', []);
};
seed();

// --- Tabs ---
$$('.tab-btn').forEach(btn=>btn.addEventListener('click', e=>{
  $$('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  $$('main section').forEach(s=>s.classList.remove('active'));
  document.querySelector(btn.dataset.target).classList.add('active');
}));

// --- Settings UI init ---
function refreshSettingsUI(){
  const s = storage.get('settings');
  $('#openTime').value = s.open;
  $('#closeTime').value = s.close;
  $('#slotSize').value = s.slot;
  $('#defaultPwd').textContent = s.adminPwd;
  $('#hoursLabel').textContent = `${s.open} - ${s.close}`;
  $('#slotSizeLabel').textContent = s.slot;
}
refreshSettingsUI();

// Staff list render
function renderStaffLists(){
  const staff = storage.get('staff', []);
  const opts = staff.map(x=>`<option value="${x.id}">${x.name}</option>`).join('');
  $('#staff').innerHTML = opts;
  $('#calStaff').innerHTML = `<option value="">Tümü</option>` + opts;
  $('#blkStaff').innerHTML = opts;
  // Editor list
  $('#staffList').innerHTML = staff.map(x=>`<div class="row"><span>${x.name}</span><button class="ghost" onclick="delStaff('${x.id}')">Sil</button></div>`).join('');
}
renderStaffLists();

window.delStaff = (id)=>{
  const appts = storage.get('appts', []);
  if (appts.some(a=>a.staffId===id && a.status!=='cancelled')) { alert('Bu berberin aktif randevuları var, silinemez.'); return; }
  storage.set('staff', storage.get('staff', []).filter(s=>s.id!==id));
  renderStaffLists();
  alert('Silindi.');
};

// Services list render
function renderSvcLists(){
  const svcs = storage.get('services', []);
  $('#svc').innerHTML = svcs.map(s=>`<option value="${s.id}" data-dur="${s.dur}" data-price="${s.price}">${s.name} — ${s.dur} dk / ${s.price} TL</option>`).join('');
  $('#svcList').innerHTML = svcs.map(s=>`<div class="row"><span>${s.name} — ${s.dur} dk / ${s.price} TL</span><button class="ghost" onclick="delSvc('${s.id}')">Sil</button></div>`).join('');
}
renderSvcLists();

window.delSvc = (id)=>{
  const appts = storage.get('appts', []);
  if (appts.some(a=>a.serviceId===id && a.status!=='cancelled')) { alert('Bu hizmete bağlı randevular var, silinemez.'); return; }
  storage.set('services', storage.get('services', []).filter(s=>s.id!==id));
  renderSvcLists();
  alert('Silindi.');
};

// Save settings
$('#saveSettings').addEventListener('click', ()=>{
  const s = storage.get('settings');
  s.open = $('#openTime').value;
  s.close = $('#closeTime').value;
  s.slot = parseInt($('#slotSize').value||15,10);
  const pwd = $('#adminPwdInput').value.trim();
  if (pwd) s.adminPwd = pwd;
  storage.set('settings', s);
  $('#adminPwdInput').value = '';
  $('#settingsStatus').textContent = 'Kaydedildi.';
  refreshSettingsUI();
  renderSlots(); // update UI
});

// Add staff/service
$('#addStaff').addEventListener('click', ()=>{
  const name = $('#newStaffName').value.trim();
  if (!name) return;
  const list = storage.get('staff', []); list.push({id:uuid(), name});
  storage.set('staff', list); $('#newStaffName').value=''; renderStaffLists();
});
$('#addSvc').addEventListener('click', ()=>{
  const name = $('#newSvcName').value.trim();
  const dur = parseInt($('#newSvcDur').value||0,10);
  const price = parseInt($('#newSvcPrice').value||0,10);
  if (!name || !dur || !price) { alert('Hizmet adı / süre / fiyat gerekli.'); return; }
  const list = storage.get('services', []); list.push({id:uuid(), name, dur, price});
  storage.set('services', list); $('#newSvcName').value=''; $('#newSvcDur').value=''; $('#newSvcPrice').value=''; renderSvcLists();
});

// --- Customer auth ---
let currentUser = null;
$('#loginBtn').addEventListener('click', ()=>{
  const name = $('#c_name').value.trim();
  const phone = $('#c_phone').value.trim();
  if (!name || !phone) { $('#loginStatus').textContent='Ad ve telefon gerekli.'; return; }
  const users = storage.get('users', []);
  let u = users.find(x=>x.phone===phone);
  if (!u){ u = {id:uuid(), name, phone}; users.push(u); storage.set('users', users); }
  else { u.name = name; storage.set('users', users); }
  currentUser = u;
  $('#loginStatus').innerHTML = '<span class="ok">Giriş başarılı.</span>';
  $('#whoami').textContent = `Giriş: ${u.name} (${u.phone})`;
  loadMyAppts();
});

// --- Slots generator ---
$('#date').value = todayISO();
function renderSlots(){
  const s = storage.get('settings');
  $('#hoursLabel').textContent = `${s.open} - ${s.close}`;
  $('#slotSizeLabel').textContent = s.slot;
  const slotsDiv = $('#slots'); slotsDiv.innerHTML = '';
  const open = toMinutes(s.open), close = toMinutes(s.close), step = s.slot;
  const staffId = $('#staff').value;
  const svcId = $('#svc').value;
  const svc = storage.get('services', []).find(x=>x.id===svcId);
  const dur = svc ? svc.dur : step;
  const date = $('#date').value;
  const conflicts = getConflicts(date, staffId);
  const blocks = getBlocks(date, staffId);
  for(let t=open; t+dur<=close; t+=step){
    const start=toHHMM(t), end=toHHMM(t+dur);
    const collide = conflicts.some(x=> overlaps(t, t+dur, x.start, x.end)) || blocks.some(x=> overlaps(t, t+dur, x.start, x.end));
    const btn = document.createElement('button'); btn.className='slot'+(collide?' disabled':''); btn.textContent = `${start}`;
    btn.dataset.time=start; if (!collide){ btn.addEventListener('click', ()=>{ $$('.slot').forEach(s=>s.classList.remove('selected')); btn.classList.add('selected'); })}
    slotsDiv.appendChild(btn);
  }
}
function overlaps(aStart,aEnd,bStart,bEnd){ return aStart<bEnd && aEnd>bStart; }

function getConflicts(date, staffId){
  const appts = storage.get('appts', []).filter(a=>a.date===date && a.staffId===staffId && a.status!=='cancelled' && a.status!=='rejected');
  return appts.map(a=>({start:toMinutes(a.time), end:toMinutes(a.time)+a.duration}));
}
function getBlocks(date, staffId){
  const blocks = storage.get('blocks', []).filter(b=>b.date===date && b.staffId===staffId);
  return blocks.map(b=>({start:toMinutes(b.start), end:toMinutes(b.end)}));
}
['#svc','#staff','#date'].forEach(sel=>$(sel).addEventListener('change', renderSlots));
renderSlots();

// --- Make appointment ---
$('#makeAppt').addEventListener('click', ()=>{
  if (!currentUser){ $('#makeStatus').textContent='Önce giriş yapınız.'; return; }
  const staffId = $('#staff').value; const svcId = $('#svc').value; const date = $('#date').value;
  const svc = storage.get('services', []).find(x=>x.id===svcId);
  const tBtn = $('.slot.selected'); if (!tBtn){ $('#makeStatus').textContent='Saat seçiniz.'; return; }
  const time = tBtn.dataset.time; const duration = svc.dur;
  // re-check conflict
  if (getConflicts(date, staffId).some(x=> overlaps(toMinutes(time), toMinutes(time)+duration, x.start, x.end))) { $('#makeStatus').textContent='Bu saat doldu, başka saat deneyin.'; renderSlots(); return; }
  const appts = storage.get('appts', []);
  const appt = {id:uuid(), userId:currentUser.id, name:currentUser.name, phone:currentUser.phone, serviceId:svcId, serviceName:svc.name, staffId, staffName: storage.get('staff', []).find(s=>s.id===staffId)?.name, date, time, duration, status:'pending', createdAt:Date.now()};
  appts.push(appt); storage.set('appts', appts);
  $('#makeStatus').innerHTML = '<span class="ok">Randevu oluşturuldu. Onay bekliyor.</span>';
  loadMyAppts(); renderSlots();
});

// WhatsApp preview
$('#waPreview').addEventListener('click', ()=>{
  const staffName = storage.get('staff', []).find(s=>s.id===$('#staff').value)?.name||'';
  const svc = storage.get('services', []).find(x=>x.id===$('#svc').value);
  const msg = `Ahmet Tekeli Erkek Kuaförü randevu talebi: ${$('#date').value} ${$('.slot.selected')?$('.slot.selected').dataset.time:''} - ${svc?svc.name:''} - ${staffName}`;
  const phone = currentUser?.phone || '905XXXXXXXXX';
  const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
});

// --- My appointments ---
function loadMyAppts(){
  const tbody = $('#myApptTbl tbody'); tbody.innerHTML='';
  if (!currentUser) return;
  const appts = storage.get('appts', []).filter(a=>a.userId===currentUser.id).sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time));
  appts.forEach(a=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${a.date}</td><td>${a.time}</td><td>${a.serviceName}</td><td>${a.staffName||''}</td><td>${a.status}</td>
    <td class="row">
      <button class="ghost" onclick="ics('${a.id}')">Takvime Ekle</button>
      <button class="ghost" onclick="resched('${a.id}')">Saat Değiştir</button>
      <button class="ghost" onclick="cancelAppt('${a.id}')">İptal</button>
    </td>`;
    tbody.appendChild(tr);
  });
}
window.cancelAppt = (id)=>{
  const appts = storage.get('appts', []); const a = appts.find(x=>x.id===id); if (!a) return;
  a.status='cancelled'; storage.set('appts', appts); loadMyAppts(); renderSlots();
};
window.resched = (id)=>{
  const s = storage.get('settings'); const open=toMinutes(s.open), close=toMinutes(s.close), step=s.slot;
  const appts = storage.get('appts', []); const a = appts.find(x=>x.id===id); if (!a) return;
  const conflicts = getConflicts(a.date, a.staffId).filter(x=> !(x.start===toMinutes(a.time) && x.end===toMinutes(a.time)+a.duration));
  let options=[]; for(let t=open; t+a.duration<=close; t+=step){ if (!conflicts.some(x=>overlaps(t,t+a.duration,x.start,x.end))) options.push(toHHMM(t)); }
  const pick = prompt(`Yeni saat seç (${options.slice(0,24).join(', ')} ...):`, options[0]||a.time);
  if (!pick) return; a.time = pick; a.status='pending'; storage.set('appts', appts); loadMyAppts(); renderSlots();
};

// ICS export
window.ics = (id)=>{
  const a = storage.get('appts', []).find(x=>x.id===id); if (!a) return;
  const start = `${a.date}T${a.time.replace(':','')}00`; // naive
  const endMin = toMinutes(a.time)+a.duration; const end = `${a.date}T${toHHMM(endMin).replace(':','')}00`;
  const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Ahmet Tekeli//Randevu//TR
BEGIN:VEVENT
UID:${a.id}
DTSTAMP:${start}Z
DTSTART:${start}
DTEND:${end}
SUMMARY:${a.serviceName} — Ahmet Tekeli Erkek Kuaförü
DESCRIPTION:Berber: ${a.staffName||''}\\nTelefon: ${a.phone}
LOCATION:Güzeloba, Antalya
END:VEVENT
END:VCALENDAR`;
  const blob = new Blob([ics], {type:'text/calendar'});
  const url = URL.createObjectURL(blob);
  const an = document.createElement('a'); an.href = url; an.download = `randevu-${a.date}-${a.time}.ics`; an.click(); URL.revokeObjectURL(url);
};

// --- Admin auth ---
let adminAuthed = false;
$('#adminLogin').addEventListener('click', ()=>{
  const pass = $('#adminPass').value.trim();
  if (pass && pass === storage.get('settings').adminPwd){
    adminAuthed = true; $('#adminArea').style.display='block'; $('#adminStatus').innerHTML='<span class="ok">Giriş başarılı.</span>'; renderQueue(); renderCal(); renderAdminSelects();
  } else {
    $('#adminStatus').innerHTML='<span class="err">Şifre hatalı.</span>';
  }
});
function renderAdminSelects(){
  const staff = storage.get('staff', []);
  $('#calStaff').innerHTML = `<option value="">Tümü</option>`+staff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  $('#blkStaff').innerHTML = staff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  $('#calDate').value = todayISO(); $('#blkDate').value = todayISO();
}
$('#refreshAdmin').addEventListener('click', ()=>{renderQueue(); renderCal();});

// Approvals queue
function renderQueue(){
  const tbody = $('#queueTbl tbody'); tbody.innerHTML='';
  const appts = storage.get('appts', []).filter(a=>a.status==='pending').sort((a,b)=>a.date.localeCompare(b.date)||a.time.localeCompare(b.time));
  appts.forEach(a=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${a.name}</td><td>${a.phone}</td><td>${a.date}</td><td>${a.time}</td><td>${a.serviceName}</td><td>${a.staffName||''}</td><td>${a.duration} dk</td>
      <td class="row">
        <button class="ghost" onclick="approve('${a.id}')">Onayla</button>
        <button class="ghost" onclick="reject('${a.id}')">Reddet</button>
      </td>`;
    tbody.appendChild(tr);
  });
}
window.approve = (id)=>{
  const appts = storage.get('appts', []); const a = appts.find(x=>x.id===id); if (!a) return;
  // conflict check at approve moment
  const conf = storage.get('appts', []).some(x=> x.id!==a.id && x.date===a.date && x.staffId===a.staffId && x.status!=='cancelled' && x.status!=='rejected' &&
    overlaps(toMinutes(a.time), toMinutes(a.time)+a.duration, toMinutes(x.time), toMinutes(x.time)+x.duration));
  if (conf){ alert('Bu saat artık dolu. Önce çakışmayı çözün.'); return; }
  a.status='approved'; storage.set('appts', appts); renderQueue(); renderCal();
};
window.reject = (id)=>{
  const appts = storage.get('appts', []); const a = appts.find(x=>x.id===id); if (!a) return;
  a.status='rejected'; storage.set('appts', appts); renderQueue(); renderCal();
};

// Calendar view
$('#viewCal').addEventListener('click', renderCal);
function renderCal(){
  const tbody = $('#calTbl tbody'); tbody.innerHTML='';
  const date = $('#calDate').value || todayISO();
  const staffId = $('#calStaff').value;
  const rows = storage.get('appts', []).filter(a=> a.date===date && (!staffId || a.staffId===staffId) && a.status!=='rejected').sort((a,b)=>a.time.localeCompare(b.time));
  rows.forEach(a=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${a.time} (${a.duration}')</td><td>${a.name}</td><td>${a.serviceName} / ${storage.get('staff', []).find(s=>s.id===a.staffId)?.name||''}</td><td>${a.status}</td>
      <td class="row">
        ${a.status!=='cancelled'?`<button class="ghost" onclick="markDone('${a.id}')">Bitti</button>`:''}
        ${a.status==='approved'?`<button class="ghost" onclick="cancelAdmin('${a.id}')">İptal</button>`:''}
      </td>`;
    tbody.appendChild(tr);
  });
}
window.markDone = (id)=>{
  const appts = storage.get('appts', []); const a = appts.find(x=>x.id===id); if (!a) return;
  a.status='completed'; storage.set('appts', appts); renderCal();
};
window.cancelAdmin = (id)=>{
  const appts = storage.get('appts', []); const a = appts.find(x=>x.id===id); if (!a) return;
  a.status='cancelled'; storage.set('appts', appts); renderCal();
};

// Blocks
$('#addBlock').addEventListener('click', ()=>{
  const staffId = $('#blkStaff').value, date = $('#blkDate').value, start=$('#blkStart').value, end=$('#blkEnd').value;
  if (!date || !start || !end) { $('#blkStatus').textContent='Tarih ve saat gerekli.'; return; }
  const blocks = storage.get('blocks', []); blocks.push({id:uuid(), staffId, date, start, end}); storage.set('blocks', blocks);
  $('#blkStatus').textContent='Blok eklendi.'; renderSlots(); renderCal();
});

// Export
$('#exportCSV').addEventListener('click', ()=>{
  const appts = storage.get('appts', []);
  const rows = [['id','date','time','duration','status','service','staff','name','phone']]
    .concat(appts.map(a=>[a.id,a.date,a.time,a.duration,a.status,a.serviceName,(storage.get('staff', []).find(s=>s.id===a.staffId)?.name||''),a.name,a.phone]));
  const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download='randevular.csv'; a.click(); URL.revokeObjectURL(url);
});
$('#exportJSON').addEventListener('click', ()=>{
  const data = {
    settings: storage.get('settings'), staff: storage.get('staff'), services: storage.get('services'),
    users: storage.get('users'), appts: storage.get('appts'), blocks: storage.get('blocks')
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download='ahmet-tekeli-randevu-data.json'; a.click(); URL.revokeObjectURL(url);
});

// Initial populate selects
$('#date').addEventListener('change', renderSlots);
$('#staff').addEventListener('change', renderSlots);
$('#svc').addEventListener('change', renderSlots);

// initial date/labels
$('#calDate').value = todayISO();

</script>
</body>
</html>
