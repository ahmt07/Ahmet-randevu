<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ahmet Tekeli - Randevu Sistemi</title>
<style>
  :root{
    --bg1:#2a2d33;
    --bg2:#181a1f;
    --card:rgba(255,255,255,.12);
    --border:rgba(255,255,255,.25);
    --white:#fff;
    --text:#0b1020;
    --muted:#6b7280;
    --accent:#caa26e;
    --accent2:#e2b97f;
    --shadow: 0 12px 30px rgba(0,0,0,.22);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    background:
      radial-gradient(1200px 600px at 10% -10%, rgba(255,255,255,.08), transparent 60%),
      radial-gradient(800px 400px at 120% 0%, rgba(255,255,255,.05), transparent 50%),
      linear-gradient(180deg, var(--bg1), var(--bg2) 60%);
    color:#0b1020;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:32px 16px;
  }
  .wrap{width:100%; max-width:980px; position:relative}
  .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; backdrop-filter:saturate(140%) blur(8px)}
  .inner{padding:24px; background:linear-gradient(180deg, rgba(255,255,255,.13), rgba(255,255,255,.06))}
  .brand{display:flex; align-items:center; justify-content:center; gap:10px}
  .badge{width:74px; height:74px; background:#fff; border-radius:50%; display:grid; place-items:center; box-shadow:0 10px 24px rgba(0,0,0,.25); overflow:hidden}
  .badge svg{width:52px; height:52px}
  h1{margin:4px 0 0; text-align:center; letter-spacing:.6px; color:#0b1224; font-size:28px}
  .sub{text-align:center; color:#2d3445; font-weight:600; letter-spacing:.4px}
  .rating{display:flex;align-items:center;justify-content:center; gap:8px; color:#8a5f1f; font-weight:700; margin:10px 0 14px}
  .rating .star{width:18px; height:18px}
  .grid{display:grid; gap:14px}
  .grid.cols-2{grid-template-columns:repeat(2,1fr)}
  .tile{background:#fff; border-radius:16px; padding:20px; border:1px solid rgba(0,0,0,.12); display:flex; align-items:center; justify-content:space-between; gap:10px}
  .tile .ttext{font-weight:800; letter-spacing:.3px}
  .tile .tbtn{padding:12px 16px; border-radius:12px; border:0; background:linear-gradient(90deg, var(--accent), var(--accent2)); color:#2b1703; font-weight:800; cursor:pointer; box-shadow:0 8px 16px rgba(0,0,0,.2)}
  .hidden{display:none !important}
  label{display:block; font-weight:700; color:#1f2937; margin:12px 6px 6px}
  input, select, button{width:100%; border:1px solid rgba(0,0,0,.15); border-radius:12px; padding:12px 14px; font-size:16px; background:#fff; color:#0b1020; outline:none}
  input:focus, select:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(202,162,110,.25)}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .row > *{flex:1 1 240px}
  .btn{margin-top:12px; padding:14px 18px; font-weight:800; letter-spacing:.4px; border-radius:14px; border:none; cursor:pointer; background:linear-gradient(90deg, var(--accent), var(--accent2)); color:#2b1703}
  .btn.secondary{background:#f3f4f6; color:#111827}
  .btn.small{padding:8px 10px; font-size:13px}
  .btn.danger{background:#fee2e2; color:#991b1b}
  .muted{color:#4b5563; font-size:14px}
  .pill{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(0,0,0,.12); background:#f8fafc}
  .appt-list{margin-top:8px}
  .item{border:1px solid rgba(0,0,0,.12); background:#fff; border-radius:12px; padding:12px 14px; margin:10px 0; display:flex; justify-content:space-between; align-items:center; gap:10px}
  .item .info{font-size:14px; color:#111827}
  .item .act{display:flex; gap:8px; flex-wrap:wrap}
  .header-actions{display:flex; gap:8px}
  .logout{background:#111827; color:#fff; border-radius:10px; padding:8px 10px; font-size:13px; border:none; cursor:pointer}
  .tabs{display:flex; gap:10px; margin:8px 4px 12px}
  .tab{flex:1; padding:10px 12px; text-align:center; background:#eef2f7; border-radius:10px; font-weight:700; cursor:pointer}
  .tab.active{background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#24140a}
  .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px}

  /* Admin look */
  .admin-wrap{background:#0b1020; color:#e5e7eb; border-radius:16px; border:1px solid #111827; padding:18px}
  .admin-h1{margin:0 0 4px; font-size:22px}
  .admin-sub{color:#94a3b8; font-size:14px; margin-bottom:12px}
  .admin-card{background:#111827; border:1px solid #1f2937; border-radius:14px; padding:14px}
  .admin-tabs{display:flex; gap:8px; margin:8px 0 12px; flex-wrap:wrap}
  .admin-tab{padding:8px 12px; border-radius:10px; background:#1f2937; color:#e5e7eb; cursor:pointer; font-weight:700}
  .admin-tab.active{background:#334155; color:#fff}
  .admin-table{width:100%; border-collapse:collapse; color:#e5e7eb}
  .admin-table th, .admin-table td{border-bottom:1px solid #273142; padding:10px 8px; font-size:14px; text-align:left}
  .admin-actions{display:flex; gap:8px; flex-wrap:wrap}
  .admin-btn{padding:8px 12px; border-radius:10px; border:1px solid #334155; background:#0f172a; color:#e5e7eb; cursor:pointer}
  .admin-btn.danger{background:#4c1d1d; border-color:#7f1d1d}
  .admin-badge{font-size:12px; padding:4px 8px; border-radius:999px; background:#0f172a; border:1px solid #334155}
  .list{display:flex; flex-direction:column; gap:8px; margin-top:8px}
  .list-item{display:flex; align-items:center; gap:8px; background:#0f172a; border:1px solid #334155; padding:8px 10px; border-radius:10px}
  .list-item input{background:#0b1220; color:#e5e7eb; border:1px solid #334155}
  @media (max-width:760px){ .grid.cols-2{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="inner">

        <!-- HEADER -->
        <div style="display:flex; align-items:center; justify-content:center; flex-direction:column">
          <div class="brand">
            <div class="badge"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none"><path d="M12 2l2.39 4.84 5.34.78-3.86 3.77.91 5.32L12 14.77 6.22 16.71l.91-5.32L3.27 7.62l5.34-.78L12 2z" stroke="#111" stroke-width="1.2" fill="#caa26e"/></svg></div>
          </div>
          <h1>AHMET TEKELİ</h1>
          <div class="sub">ERKEK KUAFÖRÜ</div>
          <div class="rating"><svg class="star" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="#eab308"><path d="M12 2l3.09 6.26L22 9.27l-5 4.88L18.18 22 12 18.56 5.82 22 7 14.15l-5 4.88 6.91-1.01L12 2z"/></svg><span>4.9 (159)</span></div>
        </div>

        <!-- LANDING -->
        <section id="landing">
          <div class="grid cols-2" style="margin-top:12px">
            <div class="tile">
              <div>
                <div class="ttext">Müşteri Girişi / Kayıt</div>
                <div class="muted">Randevu al, gör, düzenle, iptal et.</div>
              </div>
              <button class="tbtn" id="goCustomer">Giriş Yap</button>
            </div>
            <div class="tile">
              <div>
                <div class="ttext">Admin Girişi</div>
                <div class="muted">Tüm randevuları yönet ve ayarla.</div>
              </div>
              <button class="tbtn" id="goAdmin">Admin</button>
            </div>
          </div>
        </section>

        <!-- CUSTOMER APP -->
        <section id="customerApp" class="hidden">
          <div class="topbar">
            <button class="btn secondary" id="backToLanding1" style="width:auto">← Ana ekrana dön</button>
            <div class="header-actions hidden" id="authActions"><button class="logout" id="logoutBtn">Çıkış</button></div>
          </div>

          <div id="authSection">
            <div class="grid">
              <div class="row">
                <div>
                  <label>Ad Soyad</label>
                  <input id="authName" placeholder="Adınız ve Soyadınız" autocomplete="name"/>
                </div>
                <div>
                  <label>Telefon</label>
                  <input id="authPhone" placeholder="05xxxxxxxxx" inputmode="numeric"/>
                </div>
              </div>
              <div class="row">
                <div>
                  <label>Şifre</label>
                  <input id="authPwd" type="password" placeholder="Şifre belirleyin / giriniz"/>
                </div>
              </div>
              <div class="row">
                <button class="btn" id="btnRegister">Kayıt Ol</button>
                <button class="btn secondary" id="btnLogin">Giriş Yap</button>
              </div>
              <p class="muted">Hesabınız yoksa "Kayıt Ol", varsa "Giriş Yap".</p>
            </div>
          </div>

          <div id="dashboard" class="hidden">
            <div class="tabs" id="dashboardTabs">
              <div class="tab active" data-tab="book">Randevu Al</div>
              <div class="tab" data-tab="mine">Randevularım</div>
              <div class="tab" data-tab="profile">Profil</div>
            </div>

            <section id="bookingSection">
              <div class="row">
                <div>
                  <label>Berber Seçimi</label>
                  <select id="barber"></select>
                </div>
                <div>
                  <label>Hizmet Seçimi</label>
                  <select id="service"></select>
                </div>
              </div>
              <div class="row">
                <div>
                  <label>Tarih</label>
                  <input id="date" type="date"/>
                </div>
                <div>
                  <label>Saat</label>
                  <select id="time"><option value="">Uygun saat için seçimleri yapın</option></select>
                </div>
              </div>
              <button class="btn" id="bookBtn">RANDEVU AL</button>
              <p class="muted">Çakışma engelli: aynı berber aynı saatte iki randevu olmaz.</p>
            </section>

            <section id="mineSection" class="hidden">
              <div id="myAppts" class="appt-list"></div>
              <button id="newApptFromMine" class="btn secondary">Yeni Randevu</button>
            </section>

            <section id="profileSection" class="hidden">
              <div class="row">
                <div><label>Ad Soyad</label><input id="pName"/></div>
                <div><label>Telefon</label><input id="pPhone"/></div>
              </div>
              <div class="row">
                <div><label>Şifre</label><input id="pPwd" type="password" placeholder="(boş bırak = değiştirme)"/></div>
              </div>
              <button id="saveProfile" class="btn">Kaydet</button>
            </section>
          </div>
        </section>

        <!-- ADMIN APP -->
        <section id="adminApp" class="hidden">
          <div class="topbar">
            <button class="btn secondary" id="backToLanding2" style="width:auto">← Ana ekrana dön</button>
          </div>
          <div id="adminLogin" class="admin-wrap">
            <div class="admin-card">
              <h2 class="admin-h1">Admin Girişi</h2>
              <div class="admin-sub">Kullanıcı adı ve şifre ile giriş yapın.</div>
              <div class="row">
                <div><label>Kullanıcı Adı</label><input id="admUser" placeholder="admin"/></div>
                <div><label>Şifre</label><input id="admPwd" type="password" placeholder="1234"/></div>
              </div>
              <button class="btn" id="btnAdminLogin" style="margin-top:14px">Giriş Yap</button>
              <p class="muted">Demo bilgiler: <b>admin</b> / <b>1234</b></p>
            </div>
          </div>

          <div id="adminDash" class="admin-wrap hidden">
            <div class="topbar" style="margin-top:-6px">
              <div>
                <h2 class="admin-h1">Yönetim Paneli</h2>
                <div class="admin-sub">Randevular • Yeni Randevu • Ayarlar</div>
              </div>
              <button class="logout" id="adminLogout">Çıkış</button>
            </div>

            <div class="admin-card">
              <div class="admin-tabs">
                <div class="admin-tab active" data-atab="a-appts">Randevular</div>
                <div class="admin-tab" data-atab="a-new">Yeni Randevu</div>
                <div class="admin-tab" data-atab="a-settings">Ayarlar</div>
              </div>

              <!-- All appointments -->
              <div id="a-appts">
                <div class="row">
                  <div><label>Tarih</label><input id="aDateFilter" type="date"/></div>
                  <div><label>Berber</label><select id="aBarberFilter"></select></div>
                  <div><label>Müşteri adı/telefon</label><input id="aSearch" placeholder="Ara..."/></div>
                  <div><label>&nbsp;</label><button class="btn secondary" id="aClearFilters">Filtreleri Temizle</button></div>
                </div>
                <div style="overflow:auto; margin-top:12px">
                  <table class="admin-table" id="aTable">
                    <thead><tr><th>Tarih</th><th>Saat</th><th>Berber</th><th>Hizmet</th><th>Süre</th><th>Müşteri</th><th>Tel</th><th>İşlem</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

              <!-- Create appointment -->
              <div id="a-new" class="hidden">
                <div class="row">
                  <div><label>Müşteri Ad Soyad</label><input id="aname"/></div>
                  <div><label>Telefon</label><input id="aphone" placeholder="05xxxxxxxxx"/></div>
                </div>
                <div class="row">
                  <div><label>Berber</label><select id="abarber"></select></div>
                  <div><label>Hizmet</label><select id="aservice"></select></div>
                </div>
                <div class="row">
                  <div><label>Tarih</label><input id="adate" type="date"/></div>
                  <div><label>Saat</label><select id="atime"><option value="">Uygun saat için seçimleri yapın</option></select></div>
                </div>
                <button class="btn" id="aCreate">Randevu Oluştur</button>
              </div>

              <!-- Settings -->
              <div id="a-settings" class="hidden">
                <div class="row">
                  <div class="admin-card" style="flex:1">
                    <h3 style="margin:0 0 8px">Çalışma Saatleri</h3>
                    <div class="row">
                      <div><label>Başlangıç</label><input id="setStart" type="time"/></div>
                      <div><label>Bitiş</label><input id="setEnd" type="time"/></div>
                      <div>
                        <label>Slot (dk)</label>
                        <select id="setStep">
                          <option>5</option><option>10</option><option>15</option><option>20</option><option>30</option>
                        </select>
                      </div>
                    </div>
                    <button class="btn small" id="saveHours">Kaydet</button>
                  </div>

                  <div class="admin-card" style="flex:1">
                    <h3 style="margin:0 0 8px">Admin Şifresi</h3>
                    <div class="row">
                      <div><label>Mevcut Şifre</label><input id="pwdOld" type="password"/></div>
                      <div><label>Yeni Şifre</label><input id="pwdNew" type="password"/></div>
                    </div>
                    <button class="btn small" id="savePwd">Şifreyi Güncelle</button>
                    <p class="muted">Kullanıcı adı sabit: <b>admin</b></p>
                  </div>
                </div>

                <div class="row">
                  <div class="admin-card" style="flex:1">
                    <h3 style="margin:0 0 8px">Berberler</h3>
                    <div class="row">
                      <div><label>Yeni Berber</label><input id="newBarber" placeholder="İsim"/></div>
                      <div><label>&nbsp;</label><button class="btn small" id="addBarber">Ekle</button></div>
                    </div>
                    <div id="barberList" class="list"></div>
                  </div>

                  <div class="admin-card" style="flex:1">
                    <h3 style="margin:0 0 8px">Hizmetler</h3>
                    <div class="row">
                      <div><label>Ad</label><input id="svcName" placeholder="Örn: Saç + Sakal"/></div>
                      <div><label>Süre (dk)</label><input id="svcDur" type="number" min="5" step="5" value="30"/></div>
                      <div><label>&nbsp;</label><button class="btn small" id="addService">Ekle</button></div>
                    </div>
                    <div id="serviceList" class="list"></div>
                  </div>
                </div>

                <div class="admin-card" style="margin-top:12px">
                  <h3 style="margin:0 0 8px">Veri Yönetimi</h3>
                  <div class="row">
                    <div><button class="btn danger" id="resetAppts">Tüm Randevuları Sil</button></div>
                    <div><button class="btn danger" id="resetAll">Tüm Verileri Sıfırla (KULLANICILAR+AYARLAR)</button></div>
                  </div>
                  <p class="muted">Uyarı: Bu işlemler geri alınamaz.</p>
                </div>
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>
  </div>

<script>
/* ===== Storage keys ===== */
const LS_KEYS = {
  users:'atk_users',
  appts:'atk_appts',
  session:'atk_session',
  settings:'atk_settings',
  adminpwd:'atk_adminpwd'
};
/* ===== Defaults ===== */
const defaultSettings = {
  workStart:"09:00",
  workEnd:"21:00",
  stepMin:10,
  barbers:["Ahmet","Ali","Mehmet"],
  services:[
    {id:'sac', name:'Saç Kesimi', duration:30},
    {id:'sakal', name:'Sakal', duration:20},
    {id:'sacsakal', name:'Saç + Sakal', duration:50},
    {id:'fon', name:'Fön', duration:15},
    {id:'boya', name:'Saç Boya', duration:60}
  ]
};

/* ===== Helpers ===== */
function load(k,fb){ try{ return JSON.parse(localStorage.getItem(k)) ?? fb }catch(e){ return fb } }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
function uid(){ return Math.random().toString(36).slice(2,10) }
function $(id){ return document.getElementById(id) }
function toast(msg){ const t=document.createElement('div'); t.textContent=msg; Object.assign(t.style,{position:'fixed',left:'50%',top:'20px',transform:'translateX(-50%)',background:'#111827',color:'#fff',padding:'10px 14px',borderRadius:'10px',zIndex:'9999',boxShadow:'0 8px 20px rgba(0,0,0,.3)'}); document.body.appendChild(t); setTimeout(()=>t.remove(),1700) }
function cleanPhone(p){ return (p||'').replace(/\\D+/g,'') }
function timeToMin(t){ const [h,m]=t.split(':').map(Number); return h*60+m }
function minToTime(m){ const h=String(Math.floor(m/60)).padStart(2,'0'); const mm=String(m%60).padStart(2,'0'); return h+':'+mm }
function genSlots(start,end,step){ const out=[]; for(let m=timeToMin(start); m<=timeToMin(end); m+=step) out.push(minToTime(m)); return out }

/* ===== Data ===== */
let users=load(LS_KEYS.users,[]);
let appts=load(LS_KEYS.appts,[]);
let session=load(LS_KEYS.session,null);
let settings=load(LS_KEYS.settings, defaultSettings);
let adminPwd=load(LS_KEYS.adminpwd, "1234");

/* ===== Customer Auth ===== */
function setSession(u){ session=u?{id:u.id}:null; save(LS_KEYS.session,session); refreshCustomerUI() }
function currentUser(){ if(!session) return null; return users.find(u=>u.id===session.id) || null }
function register(name,phone,pwd){
  phone=cleanPhone(phone); if(!name||!phone||!pwd) return toast('Lütfen tüm alanları doldurun.');
  if(users.some(u=>u.phone===phone)) return toast('Bu telefonla kayıt var. Giriş yapın.');
  const u={id:uid(),name,phone,pwd}; users.push(u); save(LS_KEYS.users,users); toast('Kayıt başarılı.'); setSession(u);
}
function login(phone,pwd){
  phone=cleanPhone(phone); const u=users.find(u=>u.phone===phone && u.pwd===pwd); if(!u) return toast('Telefon veya şifre hatalı.');
  toast('Giriş başarılı.'); setSession(u);
}
function logout(){ setSession(null); toast('Çıkış yapıldı.') }
function updateProfile({name,phone,pwd}){
  const u=currentUser(); if(!u) return;
  if(name) u.name=name;
  if(phone){ phone=cleanPhone(phone); if(users.some(x=>x.phone===phone && x.id!==u.id)) return toast('Telefon başka kullanıcıda.'); u.phone=phone; }
  if(pwd) u.pwd=pwd; save(LS_KEYS.users,users); toast('Profil güncellendi.'); refreshCustomerUI();
}

/* ===== Booking Logic (uses settings) ===== */
function conflict({barber,date,start,duration,excludeId}){
  const s=timeToMin(start), e=s+duration;
  return appts.some(a=>{
    if(a.barber!==barber || a.date!==date) return false;
    if(excludeId && a.id===excludeId) return false;
    const as=timeToMin(a.time), ae=as+a.duration;
    return Math.max(s,as) < Math.min(e,ae);
  });
}
function availableTimes(barber,date,duration){
  if(!barber||!date||!duration) return [];
  const allSlots = genSlots(settings.workStart, settings.workEnd, settings.stepMin);
  const out=[]; for(const t of allSlots){
    const end=timeToMin(t)+duration; if(end>timeToMin(settings.workEnd)) continue;
    if(!conflict({barber,date,start:t,duration})) out.push(t);
  } return out;
}
function createAppt({userId,name,phone,barber,serviceId,date,time}){
  const svc=(settings.services||[]).find(s=>s.id===serviceId); if(!svc) return toast('Hizmet seçin.');
  if(!barber||!date||!time) return toast('Berber, tarih ve saat zorunlu.');
  if(conflict({barber,date,start:time,duration:svc.duration})) return toast('Bu saat dolu.');
  const a={id:uid(), userId:userId||null, name, phone, barber, serviceId, serviceName:svc.name, duration:svc.duration, date, time, createdAt:Date.now()};
  appts.push(a); save(LS_KEYS.appts,appts); toast('Randevu oluşturuldu.');
  renderMine(); renderAdminTable();
}
function updateAppt(id, edits){
  const i=appts.findIndex(a=>a.id===id); if(i<0) return;
  const base=appts[i]; const svc=(settings.services||[]).find(s=> (edits.serviceId||base.serviceId)===s.id);
  const barber=edits.barber ?? base.barber, date=edits.date ?? base.date, time=edits.time ?? base.time, duration=svc.duration;
  if(conflict({barber,date,start:time,duration,excludeId:id})) return toast('Seçilen saat dolu.');
  appts[i] = {...base, ...edits, serviceName:svc.name, duration}; save(LS_KEYS.appts,appts); toast('Randevu güncellendi.');
  renderMine(); renderAdminTable();
}
function cancelAppt(id){ appts=appts.filter(a=>a.id!==id); save(LS_KEYS.appts,appts); toast('Randevu iptal edildi.'); renderMine(); renderAdminTable(); }

/* ===== Customer UI ===== */
function populateBarbers(selId){
  const s=$(selId); const arr=settings.barbers||[];
  s.innerHTML = '<option value="">Bir berber seçin</option>' + arr.map(x=>`<option value="${x}">${x}</option>`).join('');
}
function populateServices(selId){
  const s=$(selId); const arr=settings.services||[];
  s.innerHTML='<option value="">Hizmet seçin</option>'+arr.map(x=>`<option value="${x.id}">${x.name} (${x.duration} dk)</option>`).join('');
}
function refreshTimes(selTimeId, selBarberId, selDateId, selServiceId){
  const barber=$(selBarberId).value, date=$(selDateId).value, svc=(settings.services||[]).find(s=>s.id===$(selServiceId).value);
  const tSel=$(selTimeId); tSel.innerHTML=''; if(!barber||!date||!svc){ tSel.innerHTML='<option value="">Uygun saat için seçimleri yapın</option>'; return; }
  const list=availableTimes(barber,date,svc.duration); tSel.innerHTML=list.length? list.map(t=>`<option value="${t}">${t}</option>`).join('') : '<option>Uygun saat yok</option>';
}
function setTab(name){
  document.querySelectorAll('#dashboardTabs .tab').forEach(el=>el.classList.toggle('active', el.dataset.tab===name));
  $('bookingSection').classList.toggle('hidden', name!=='book');
  $('mineSection').classList.toggle('hidden', name!=='mine');
  $('profileSection').classList.toggle('hidden', name!=='profile');
}
function renderMine(){
  const u=currentUser(); const wrap=$('myAppts'); if(!wrap) return;
  wrap.innerHTML='';
  if(!u){ wrap.innerHTML='<div class="muted">Giriş yapın.</div>'; return; }
  const mine=appts.filter(a=>a.userId===u.id).sort((a,b)=> a.date.localeCompare(b.date) || a.time.localeCompare(b.time));
  if(!mine.length){ wrap.innerHTML='<div class="muted">Henüz randevunuz yok.</div>'; return; }
  for(const a of mine){
    const div=document.createElement('div'); div.className='item';
    const left=document.createElement('div'); left.className='info';
    left.innerHTML=`<div><strong>${a.date} • ${a.time}</strong> <span class="pill">${a.barber}</span></div><div>${a.serviceName} <span class="muted">(${a.duration} dk)</span></div>`;
    const right=document.createElement('div'); right.className='act';
    const edit=document.createElement('button'); edit.className='btn secondary'; edit.textContent='Düzenle';
    const del=document.createElement('button'); del.className='btn secondary'; del.textContent='İptal';
    edit.onclick=()=> openEdit(a);
    del.onclick=()=> { if(confirm('Randevu iptal edilsin mi?')) cancelAppt(a.id) };
    right.append(edit,del); div.append(left,right); wrap.append(div);
  }
}
function openEdit(a){
  setTab('book');
  $('barber').value=a.barber;
  $('service').value=a.serviceId;
  $('date').value=a.date;
  refreshTimes('time','barber','date','service');
  $('time').value=a.time;
  $('bookBtn').textContent='RANDEVUYU GÜNCELLE'; $('bookBtn').dataset.editId=a.id;
}
function resetBookButton(){ $('bookBtn').textContent='RANDEVU AL'; delete $('bookBtn').dataset.editId }
function refreshCustomerUI(){
  const u=currentUser();
  $('authActions').classList.toggle('hidden', !u);
  $('authSection').classList.toggle('hidden', !!u);
  $('dashboard').classList.toggle('hidden', !u);
  if(u){
    $('pName').value=u.name; $('pPhone').value=u.phone;
    populateBarbers('barber'); populateServices('service');
    refreshTimes('time','barber','date','service');
    renderMine(); resetBookButton(); setTab('book');
  }
}

/* ===== Admin UI ===== */
let adminLogged=false;
function setAdminTab(name){
  document.querySelectorAll('.admin-tab').forEach(el=>el.classList.toggle('active', el.dataset.atab===name));
  ['a-appts','a-new','a-settings'].forEach(id=> $(id).classList.toggle('hidden', id!==name));
}
function renderAdminTable(){
  if(!adminLogged) return;
  const body=$('#aTable tbody'); body.innerHTML='';
  const dateF=$('aDateFilter').value; const barbF=$('aBarberFilter').value; const q=($('aSearch').value||'').toLowerCase();
  let list=[...appts];
  if(dateF) list=list.filter(a=>a.date===dateF);
  if(barbF) list=list.filter(a=>a.barber===barbF);
  if(q) list=list.filter(a=> (a.name||'').toLowerCase().includes(q) || (a.phone||'').toLowerCase().includes(q));
  list.sort((a,b)=> a.date.localeCompare(b.date) || a.time.localeCompare(b.time));
  if(!list.length){ const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=8; td.textContent='Kayıt yok.'; td.style.color='#94a3b8'; tr.append(td); body.append(tr); return; }
  for(const a of list){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${a.date}</td><td>${a.time}</td><td>${a.barber}</td><td>${a.serviceName}</td><td>${a.duration} dk</td><td>${a.name||'-'}</td><td>${a.phone||'-'}</td>`;
    const td=document.createElement('td'); td.className='admin-actions';
    const btnDel=document.createElement('button'); btnDel.className='admin-btn danger'; btnDel.textContent='Sil';
    const btnEdit=document.createElement('button'); btnEdit.className='admin-btn'; btnEdit.textContent='Düzenle';
    btnDel.onclick=()=>{ if(confirm('Silinsin mi?')) cancelAppt(a.id) };
    btnEdit.onclick=()=> openAdminEdit(a);
    td.append(btnEdit, btnDel); tr.append(td);
    body.append(tr);
  }
}
function openAdminEdit(a){
  setAdminTab('a-new');
  $('aname').value=a.name||''; $('aphone').value=a.phone||'';
  $('abarber').value=a.barber; $('aservice').value=a.serviceId; $('adate').value=a.date;
  refreshTimes('atime','abarber','adate','aservice'); $('atime').value=a.time;
  $('aCreate').textContent='Randevuyu Güncelle'; $('aCreate').dataset.editId=a.id;
}
function refreshAdminSelectors(){
  const bf=$('aBarberFilter'); bf.innerHTML='<option value="">Hepsi</option>'+settings.barbers.map(b=>`<option>${b}</option>`).join('');
  populateBarbers('abarber'); populateServices('aservice');
}

/* ===== Admin Settings (Hours, Barbers, Services, Password, Resets) ===== */
function loadSettingsToUI(){
  $('setStart').value=settings.workStart;
  $('setEnd').value=settings.workEnd;
  $('setStep').value=String(settings.stepMin);

  const bl=$('barberList'); bl.innerHTML='';
  settings.barbers.forEach((b,i)=>{
    const row=document.createElement('div'); row.className='list-item';
    const inp=document.createElement('input'); inp.value=b; inp.oninput=()=>{ settings.barbers[i]=inp.value; save(LS_KEYS.settings, settings); refreshAdminSelectors(); populateBarbers('barber'); };
    const del=document.createElement('button'); del.className='btn small danger'; del.textContent='Sil';
    del.onclick=()=>{ settings.barbers.splice(i,1); save(LS_KEYS.settings, settings); loadSettingsToUI(); refreshAdminSelectors(); populateBarbers('barber'); };
    row.append(inp, del); bl.append(row);
  });

  const sl=$('serviceList'); sl.innerHTML='';
  settings.services.forEach((s,i)=>{
    const row=document.createElement('div'); row.className='list-item';
    const name=document.createElement('input'); name.value=s.name; name.oninput=()=>{ s.name=name.value; save(LS_KEYS.settings, settings); refreshAdminSelectors(); populateServices('service'); };
    const dur=document.createElement('input'); dur.type='number'; dur.min=5; dur.step=5; dur.value=s.duration; dur.oninput=()=>{ s.duration=parseInt(dur.value||'0'); save(LS_KEYS.settings, settings); populateServices('service'); };
    const del=document.createElement('button'); del.className='btn small danger'; del.textContent='Sil';
    del.onclick=()=>{ settings.services.splice(i,1); save(LS_KEYS.settings, settings); loadSettingsToUI(); populateServices('service'); };
    row.append(name, dur, del); sl.append(row);
  });

  refreshAdminSelectors();
}
$('saveHours').onclick=()=>{
  const st=$('setStart').value, en=$('setEnd').value, step=parseInt($('setStep').value);
  if(!st||!en||timeToMin(st)>=timeToMin(en)) return toast('Saat aralığı geçersiz.');
  settings.workStart=st; settings.workEnd=en; settings.stepMin=step; save(LS_KEYS.settings, settings);
  toast('Çalışma saatleri güncellendi.');
};
$('addBarber').onclick=()=>{
  const v=$('newBarber').value.trim(); if(!v) return;
  settings.barbers.push(v); save(LS_KEYS.settings, settings); $('newBarber').value=''; loadSettingsToUI();
};
$('addService').onclick=()=>{
  const name=$('svcName').value.trim(); const dur=parseInt($('svcDur').value);
  if(!name||!dur) return;
  settings.services.push({id: 'svc_'+uid(), name, duration:dur}); save(LS_KEYS.settings, settings);
  $('svcName').value=''; $('svcDur').value='30'; loadSettingsToUI();
};
$('savePwd').onclick=()=>{
  const old=$('pwdOld').value, nw=$('pwdNew').value;
  if(old!==adminPwd) return toast('Mevcut şifre yanlış.');
  if(!nw || nw.length<3) return toast('Yeni şifre çok kısa.');
  adminPwd=nw; save(LS_KEYS.adminpwd, adminPwd); $('pwdOld').value=''; $('pwdNew').value=''; toast('Admin şifresi güncellendi.');
};
$('resetAppts').onclick=()=>{
  if(confirm('Tüm randevular silinsin mi?')){ appts=[]; save(LS_KEYS.appts, appts); renderAdminTable(); toast('Randevular temizlendi.'); }
};
$('resetAll').onclick=()=>{
  if(confirm('TÜM VERİLER (kullanıcılar+randevular+ayarlar) silinsin mi?')){
    users=[]; appts=[]; settings=JSON.parse(JSON.stringify(defaultSettings)); adminPwd="1234"; session=null;
    save(LS_KEYS.users, users); save(LS_KEYS.appts, appts); save(LS_KEYS.settings, settings); save(LS_KEYS.adminpwd, adminPwd); save(LS_KEYS.session, session);
    refreshCustomerUI(); if(adminLogged) renderAdminTable(); loadSettingsToUI(); refreshAdminSelectors(); toast('Her şey sıfırlandı.');
  }
};

/* ===== EVENTS ===== */
// Landing
$('goCustomer').onclick=()=>{ $('landing').classList.add('hidden'); $('customerApp').classList.remove('hidden'); }
$('goAdmin').onclick=()=>{ $('landing').classList.add('hidden'); $('adminApp').classList.remove('hidden'); }

// Back
$('backToLanding1').onclick=()=>{ $('customerApp').classList.add('hidden'); $('landing').classList.remove('hidden') }
$('backToLanding2').onclick=()=>{ $('adminApp').classList.add('hidden'); $('landing').classList.remove('hidden') }

// Customer auth
$('btnRegister').onclick=()=> register($('authName').value.trim(), $('authPhone').value.trim(), $('authPwd').value);
$('btnLogin').onclick=()=> login($('authPhone').value.trim(), $('authPwd').value);
$('logoutBtn').onclick=logout;

// Customer tabs
document.querySelectorAll('#dashboardTabs .tab').forEach(t=> t.addEventListener('click', ()=> setTab(t.dataset.tab)));

// Customer booking inputs
;['barber','service','date'].forEach(id=> $(id).addEventListener('change', ()=> refreshTimes('time','barber','date','service')));

$('bookBtn').onclick=()=>{
  const u=currentUser(); if(!u) return;
  const editId=$('bookBtn').dataset.editId;
  const barber=$('barber').value; const serviceId=$('service').value; const date=$('date').value; const time=$('time').value;
  if(editId){ updateAppt(editId, {barber, serviceId, date, time}); resetBookButton(); setTab('mine'); }
  else{ createAppt({userId:u.id, name=u.name, phone=u.phone, barber, serviceId, date, time}); setTab('mine'); }
};
$('newApptFromMine').onclick=()=> setTab('book');
$('saveProfile').onclick=()=> updateProfile({name:$('pName').value.trim(), phone:$('pPhone').value.trim(), pwd:$('pPwd').value});

// Admin login
$('btnAdminLogin').onclick=()=>{
  const u=$('admUser').value.trim(), p=$('admPwd').value;
  if(u==='admin' && p===adminPwd){ 
    adminLogged=true; $('adminLogin').classList.add('hidden'); $('adminDash').classList.remove('hidden');
    refreshAdminSelectors();
    populateBarbers('barber'); populateServices('service');
    populateBarbers('abarber'); populateServices('aservice');
    loadSettingsToUI();
    renderAdminTable(); toast('Admin girişi başarılı.');
  } else toast('Hatalı bilgi.');
};
$('adminLogout').onclick=()=>{ adminLogged=false; $('adminDash').classList.add('hidden'); $('adminLogin').classList.remove('hidden'); toast('Çıkış yapıldı.'); }

// Admin tabs + filters
document.querySelectorAll('.admin-tab').forEach(t=> t.addEventListener('click', ()=> setAdminTab(t.dataset.atab)));
;['aDateFilter','aBarberFilter','aSearch'].forEach(id=> $(id).addEventListener('input', renderAdminTable));
$('aClearFilters').onclick=()=>{ $('aDateFilter').value=''; $('aBarberFilter').value=''; $('aSearch').value=''; renderAdminTable() };

// Admin create/update
;['abarber','aservice','adate'].forEach(id=> $(id).addEventListener('change', ()=> refreshTimes('atime','abarber','adate','aservice')));
$('aCreate').onclick=()=>{
  const name=$('aname').value.trim(), phone=$('aphone').value.trim(), barber=$('abarber').value, serviceId=$('aservice').value, date=$('adate').value, time=$('atime').value;
  const editId=$('aCreate').dataset.editId;
  if(editId){ updateAppt(editId, {barber, serviceId, date, time, name, phone}); $('aCreate').textContent='Randevuyu Güncelle'; delete $('aCreate').dataset.editId; setAdminTab('a-appts'); }
  else{ createAppt({name, phone, barber, serviceId, date, time}); setAdminTab('a-appts'); }
  const u = users.find(x=> cleanPhone(x.phone)===cleanPhone(phone));
  if(u && !editId){
    const last = appts[appts.length-1]; if(last && !last.userId){ last.userId = u.id; save(LS_KEYS.appts, appts); }
  }
  renderAdminTable();
};

/* INIT */
(function init(){
  if(!settings || !settings.barbers || !settings.services){ settings = JSON.parse(JSON.stringify(defaultSettings)); save(LS_KEYS.settings, settings); }
  populateBarbers('barber'); populateServices('service');
  const bf=$('aBarberFilter'); bf.innerHTML='<option value="">Hepsi</option>'+settings.barbers.map(b=>`<option>${b}</option>`).join('');
})();
</script>
</body>
</html>
