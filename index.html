<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Berber & Kuaför — Randevu (SAFE)</title>
<style>
  :root{--bg:#0b0f19;--ink:#e7eaf0;--muted:#a9b0c3;--line:#222a3d;--gold:#f4d27a;--gold2:#d4af37}
  *{box-sizing:border-box} html,body{margin:0;padding:0;color:var(--ink);font:15px/1.6 Arial,system-ui;background:#0b0f19;min-height:100vh}
  /* arka plan logo */
  body:before{content:"";position:fixed;inset:0;background:url('logo.png') no-repeat center/220px;opacity:.22;filter:drop-shadow(0 6px 18px rgba(0,0,0,.5));pointer-events:none}
  .wrap{max-width:900px;margin:0 auto;padding:20px}
  .card{background:#0f1422cc;border:1px solid #2a334a;border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.45);padding:18px}
  .center{min-height:90vh;display:grid;place-items:center}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .col{display:flex;flex-direction:column;gap:8px}
  input,select,button{font:inherit}
  input,select{width:100%;padding:10px;border:1px solid var(--line);background:#0d1321;color:var(--ink);border-radius:10px}
  button{padding:10px 14px;border-radius:10px;border:1px solid #3a455f;background:#0d1321;color:var(--ink);cursor:pointer}
  .primary{background:linear-gradient(180deg,var(--gold),var(--gold2));color:#1a1303;border-color:#7a6420;font-weight:bold}
  .muted{color:var(--muted)} .title{font-weight:700;font-size:20px}
  .tabs button{background:#111a2d} .hidden{display:none}
  .chip{display:inline-block;border:1px solid #2a334a;border-radius:999px;padding:4px 8px;font-size:12px;background:#0d1321}
  .divider{height:1px;margin:12px 0;background:linear-gradient(90deg,transparent,#33405d,transparent)}
</style>
</head>
<body>

<!-- AUTH -->
<div id="auth" class="wrap center">
  <div class="card" style="width:100%;max-width:520px">
    <div class="row" style="justify-content:center">
      <img src="logo.png" alt="" style="height:34px;opacity:.9">
      <div style="font-size:22px;font-weight:700">Berber & Kuaför — Randevu</div>
    </div>
    <p class="muted" style="text-align:center;margin-top:6px">Giriş yapın veya <b>kayıt olun</b>.</p>

    <div class="col">
      <div class="title">Üye Girişi</div>
      <input id="loginPhone" type="tel" placeholder="Telefon (05xx...)">
      <input id="loginPass" type="password" placeholder="Şifre">
      <div class="row" style="justify-content:flex-end">
        <button class="primary" id="btnLogin">Giriş Yap</button>
        <button id="btnShowReg">Kayıt Ol</button>
      </div>
    </div>

    <div id="regBox" class="col hidden" style="margin-top:12px">
      <div class="title">İşletme Kayıt</div>
      <input id="regName" type="text" placeholder="İşletme adı">
      <input id="regPhone" type="tel" placeholder="Telefon (05xx...)">
      <input id="regPass" type="password" placeholder="Şifre">
      <div class="row" style="justify-content:flex-end">
        <button class="primary" id="btnRegister">Kayıt Ol</button>
      </div>
      <div id="regError" class="muted" style="color:#fca5a5"></div>
    </div>

    <div class="divider"></div>
    <div class="muted" style="text-align:center">Bu cihazda kayıtlı işletmeler</div>
    <div id="localShops" class="row" style="justify-content:center"></div>
  </div>
</div>

<!-- OWNER -->
<div id="owner" class="wrap hidden">
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="title">🏪 <span id="shopHdr"></span></div>
      <button id="btnLogout">Çıkış</button>
    </div>
    <div class="divider"></div>

    <div class="row">
      <div class="col" style="flex:1 1 260px">
        <div class="title">Bağlantılar</div>
        <div class="chip">Müşteri: <span id="pubLink"></span></div>
        <div class="chip">Admin: <span id="admLink"></span></div>
      </div>
      <div class="col" style="flex:1 1 260px">
        <div class="title">Çalışma</div>
        <div class="row">
          <input id="start" type="time" value="09:00" style="width:120px">
          <input id="end" type="time" value="20:00" style="width:120px">
          <input id="slot" type="number" value="30" min="5" step="5" style="width:90px">
        </div>
        <button id="btnSave">Kaydet</button>
      </div>
    </div>

    <div class="divider"></div>
    <div class="row">
      <div class="col" style="flex:1 1 260px">
        <div class="title">Hizmet</div>
        <div class="row"><input id="svcName" placeholder="Saç + Sakal"><input id="svcMins" type="number" value="30" style="width:110px"><button id="btnAddSvc">Ekle</button></div>
        <div id="svcList"></div>
      </div>
      <div class="col" style="flex:1 1 260px">
        <div class="title">Usta</div>
        <div class="row"><input id="barberName" placeholder="Usta adı"><button id="btnAddBarber">Ekle</button></div>
        <div id="barberList"></div>
      </div>
    </div>

    <div class="divider"></div>
    <div class="title">Randevular</div>
    <div id="bookList"></div>
  </div>
</div>

<!-- PUBLIC -->
<div id="public" class="wrap hidden">
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="title">💈 <span id="pubName"></span></div>
      <div class="chip" id="pubAddr"></div>
    </div>
    <div class="divider"></div>

    <div class="row">
      <select id="selSvc" style="min-width:180px"></select>
      <select id="selBarber" style="min-width:160px"></select>
      <input id="selDate" type="date" style="min-width:160px">
    </div>

    <div class="divider"></div>
    <div id="slots"></div>

    <div class="divider"></div>
    <div class="row">
      <input id="cName" placeholder="Ad Soyad" style="min-width:220px">
      <input id="cPhone" placeholder="Telefon" style="min-width:180px">
      <button class="primary" id="btnBook">Randevu Al</button>
      <div class="chip">Seçim: <span id="selInfo">—</span></div>
    </div>
  </div>
</div>

<script>
/*** BASİT SAKLAMA ***/
var DBKEY="bk_shops_v1";
function loadDB(){ try{return JSON.parse(localStorage.getItem(DBKEY)||"{}");}catch(e){return {}} }
function saveDB(db){ try{localStorage.setItem(DBKEY, JSON.stringify(db));}catch(e){ alert("Tarayıcı kaydetmeyi engelliyor (LocalStorage)."); } }
function keyOf(phone){ return "shop_"+String(phone||"").replace(/\D/g,""); }
function b64(s){ try{return btoa(unescape(encodeURIComponent(s)));}catch(e){return btoa(s);} }
function eqHash(h, p){ try{ return h===b64(p) || h===btoa(p);}catch(e){return h===b64(p);} }
function pad(n){ return (n<10?"0":"")+n; }

/*** EKRAN GEÇİŞLERİ ***/
function show(id){ ["auth","owner","public"].forEach(function(x){ document.getElementById(x).classList.add("hidden"); }); document.getElementById(id).classList.remove("hidden"); }

/*** AUTH ***/
document.getElementById("btnShowReg").onclick=function(){ document.getElementById("regBox").classList.toggle("hidden"); };
document.getElementById("btnRegister").onclick=function(){
  var name=document.getElementById("regName").value.trim();
  var phR=document.getElementById("regPhone").value.trim();
  var pass=document.getElementById("regPass").value.trim();
  var err=document.getElementById("regError");
  if(!name||!phR||!pass){ err.textContent="Eksik bilgi."; err.style.display="block"; return; }
  var phone=phR.replace(/\D/g,""); if(phone.length<10){ err.textContent="Telefon hatalı."; err.style.display="block"; return; }
  var db=loadDB(), k=keyOf(phone); if(db[k]){ err.textContent="Bu telefonla kayıt var."; err.style.display="block"; return; }
  db[k]={id:k,ownerPhone:phone,pass:b64(pass),name:name,work:{start:"09:00",end:"20:00",slot:30,maxDays:14},services:[],barbers:[],bookings:[]};
  saveDB(db); err.style.display="none"; alert("Kayıt tamam! Giriş yapın.");
  document.getElementById("loginPhone").value = phone[0]==="0" ? phone : "0"+phone;
  document.getElementById("loginPass").focus();
  renderLocal();
};

document.getElementById("btnLogin").onclick=function(){
  var phone=document.getElementById("loginPhone").value.trim();
  var pass=document.getElementById("loginPass").value.trim();
  var k=keyOf(phone), db=loadDB();
  if(!db[k]){ alert("Kayıt yok."); return; }
  if(!eqHash(db[k].pass, pass)){ alert("Şifre hatalı."); return; }
  window.__shopId=k; openOwner();
};

/*** OWNER ***/
function openOwner(){
  var db=loadDB(), s=db[__shopId]; if(!s){ alert("Bulunamadı"); return; }
  show("owner");
  document.getElementById("shopHdr").textContent=s.name;
  document.getElementById("pubLink").textContent=location.origin+location.pathname+"?shop="+encodeURIComponent(s.id);
  document.getElementById("admLink").textContent=location.origin+location.pathname+"?admin="+encodeURIComponent(s.id);
  document.getElementById("start").value=s.work.start; document.getElementById("end").value=s.work.end; document.getElementById("slot").value=s.work.slot;
  renderServices(); renderBarbers(); renderBookings();
}
document.getElementById("btnSave").onclick=function(){
  var db=loadDB(), s=db[__shopId];
  s.work.start=document.getElementById("start").value;
  s.work.end=document.getElementById("end").value;
  s.work.slot=parseInt(document.getElementById("slot").value||30,10);
  saveDB(db); openOwner();
};
document.getElementById("btnLogout").onclick=function(){ __shopId=null; show("auth"); renderLocal(); };

/*** SERVICES ***/
document.getElementById("btnAddSvc").onclick=function(){
  var n=document.getElementById("svcName").value.trim();
  var m=parseInt(document.getElementById("svcMins").value||30,10);
  if(!n){ alert("Hizmet adı gerekli"); return; }
  var db=loadDB(), s=db[__shopId]; s.services.push({id:Math.random().toString(36).slice(2,8),name:n,mins:m}); saveDB(db);
  document.getElementById("svcName").value=""; renderServices();
};
function renderServices(){
  var db=loadDB(), s=db[__shopId], box=document.getElementById("svcList"); box.innerHTML="";
  s.services.forEach(function(x,i){ var d=document.createElement("div"); d.className="chip"; d.textContent=x.name+" ("+x.mins+" dk)"; box.appendChild(d); });
}

/*** BARBERS ***/
document.getElementById("btnAddBarber").onclick=function(){
  var n=document.getElementById("barberName").value.trim(); if(!n){ alert("Usta adı gerekli"); return; }
  var db=loadDB(), s=db[__shopId]; s.barbers.push({id:Math.random().toString(36).slice(2,8),name:n}); saveDB(db);
  document.getElementById("barberName").value=""; renderBarbers();
};
function renderBarbers(){
  var db=loadDB(), s=db[__shopId], box=document.getElementById("barberList"); box.innerHTML="";
  s.barbers.forEach(function(x){ var d=document.createElement("div"); d.className="chip"; d.textContent=x.name; box.appendChild(d); });
}

/*** BOOKINGS LIST ***/
function renderBookings(){
  var db=loadDB(), s=db[__shopId], box=document.getElementById("bookList"); box.innerHTML="";
  if(!s.bookings.length){ box.innerHTML='<div class="muted">Randevu yok.</div>'; return; }
  s.bookings.slice().reverse().forEach(function(b){
    var d=document.createElement("div"); d.className="chip";
    d.textContent=b.date+" "+b.time+" • "+b.customer.name; box.appendChild(d);
  });
}

/*** PUBLIC PAGE ***/
function openPublic(id){
  var db=loadDB(), s=db[id]; if(!s){ alert("İşletme bulunamadı"); return; }
  window.__pubId=id; show("public");
  document.getElementById("pubName").textContent=s.name; document.getElementById("pubAddr").textContent=s.addr||"";
  var svc=document.getElementById("selSvc"), br=document.getElementById("selBarber");
  svc.innerHTML=""; br.innerHTML="";
  s.services.forEach(function(x){ var o=document.createElement("option"); o.value=x.id; o.textContent=x.name+" ("+x.mins+" dk)"; svc.appendChild(o); });
  s.barbers.forEach(function(x){ var o=document.createElement("option"); o.value=x.id; o.textContent=x.name; br.appendChild(o); });
  var d=document.getElementById("selDate"); var today=new Date(); today.setHours(0,0,0,0); d.value=today.toISOString().slice(0,10);
  makeSlots();
}
function makeSlots(){
  var db=loadDB(), s=db[__pubId]; var svcId=document.getElementById("selSvc").value;
  var svc=s.services.filter(function(x){return x.id===svcId})[0] || {mins:s.work.slot};
  var br=document.getElementById("selBarber").value;
  var date=document.getElementById("selDate").value;
  var box=document.getElementById("slots"); box.innerHTML="";
  function pad(n){return (n<10?"0":"")+n;}
  var sh=s.work.start.split(":").map(Number), eh=s.work.end.split(":").map(Number);
  var cur=new Date(date+"T"+pad(sh[0])+":"+pad(sh[1])), end=new Date(date+"T"+pad(eh[0])+":"+pad(eh[1]));
  var taken={}; s.bookings.forEach(function(b){ if(b.date===date && (!br || b.barberId===br)) taken[b.time]=true; });
  window.__sel=null; document.getElementById("selInfo").textContent="—";
  while(cur<end){
    var t=pad(cur.getHours())+":"+pad(cur.getMinutes());
    var btn=document.createElement("button"); btn.textContent=t; btn.style.margin="4px";
    if(taken[t]){ btn.disabled=true; btn.title="Dolu"; }
    btn.onclick=(function(time){ return function(){ __sel={time:time, svcId:svcId, barberId:br, date:date}; document.getElementById("selInfo").textContent=date+" "+time; }; })(t);
    box.appendChild(btn);
    cur=new Date(cur.getTime()+(svc.mins||s.work.slot)*60000);
  }
}
document.getElementById("selSvc").onchange=makeSlots;
document.getElementById("selBarber").onchange=makeSlots;
document.getElementById("selDate").onchange=makeSlots;

document.getElementById("btnBook").onclick=function(){
  if(!__sel){ alert("Önce saat seçin"); return; }
  var n=document.getElementById("cName").value.trim(); var p=document.getElementById("cPhone").value.trim();
  if(!n||!p){ alert("Ad ve telefon gerekli"); return; }
  var db=loadDB(), s=db[__pubId];
  var exists=s.bookings.some(function(b){ return b.date===__sel.date && b.time===__sel.time && b.barberId===__sel.barberId; });
  if(exists){ alert("Bu saat dolu."); makeSlots(); return; }
  s.bookings.push({id:Math.random().toString(36).slice(2,8),date:__sel.date,time:__sel.time,serviceId:__sel.svcId,barberId:__sel.barberId,customer:{name:n,phone:p}});
  saveDB(db); alert("Randevunuz alındı!"); document.getElementById("cName").value=""; document.getElementById("cPhone").value=""; makeSlots(); renderBookings();
};

/*** ROUTER & LOKAL KISAYOL ***/
function renderLocal(){
  var box=document.getElementById("localShops"); box.innerHTML="";
  var db=loadDB(); Object.keys(db).forEach(function(k){
    var a=document.createElement("button"); a.className="chip"; a.textContent="👤 "+db[k].name; a.onclick=function(){ openPublic(k); };
    var b=document.createElement("button"); b.className="chip"; b.textContent="🔐 Admin"; b.onclick=function(){ __shopId=k; openOwner(); };
    var w=document.createElement("div"); w.className="row"; w.appendChild(a); w.appendChild(b); box.appendChild(w);
  });
}
(function(){
  renderLocal();
  var q=location.search.replace("?","").split("&").reduce(function(m,p){var t=p.split("="); m[t[0]]=decodeURIComponent(t[1]||""); return m; },{});
  if(q.shop){ openPublic(q.shop); }
  else if(q.admin){ __shopId=q.admin; openOwner(); }
})();
</script>
</body>
</html>
